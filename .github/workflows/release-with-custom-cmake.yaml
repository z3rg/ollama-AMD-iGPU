name: Release with Update CMake Configuration

on:
  #push:
  #  branches: [ "main" ]
  workflow_dispatch: # Agar bisa dijalankan manual via tombol

jobs:
  configure-and-build:
    name: Modify Configs on Windows Runner
    runs-on: [self-hosted, windows]
    
    # Mengatur default shell ke PowerShell Core (pwsh) untuk konsistensi
    defaults:
      run:
        shell: pwsh

    steps:
      # --- LANGKAH 1: CHECKOUT ---
      - name: Checkout Repository
        uses: actions/checkout@v4

      # --- LANGKAH 2: REPLACE CMAKELISTS.TXT (REGEX) ---
      - name: Update CMakeLists.txt Regex
        run: |
          $file = "CMakeLists.txt"
          
          # Cek apakah file ada sebelum diproses
          if (-not (Test-Path $file)) {
            Write-Error "File $file tidak ditemukan!"
            exit 1
          }

          # String Lama (Target Regex)
          $stringLama = 'list(FILTER AMDGPU_TARGETS INCLUDE REGEX "^gfx(94[012]|101[02]|1030|110[012]|120[01])$")'
          
          # String Baru
          $stringBaru = 'list(FILTER AMDGPU_TARGETS INCLUDE REGEX "^gfx(803|900(:xnack-)|902|90c(:xnack-)|1010(:xnack-)|1011|1012(:xnack-)|103[0-6]|110[0-3]|1150)$")'

          # Proses Escape Regex & Replace
          Write-Host "Sedang memproses $file..."
          $pattern = [Regex]::Escape($stringLama)
          
          # Baca, Replace, Simpan
          $content = Get-Content $file -Raw
          $content = $content -replace $pattern, $stringBaru
          Set-Content -Path $file -Value $content
          
          Write-Host "Sukses: CMakeLists.txt telah diupdate."

      # --- LANGKAH 3: REPLACE CMAKEPRESETS.JSON (LITERAL) ---
      - name: Update CMakePresets.json Target
        run: |
          $file = "CMakePresets.json"

          if (-not (Test-Path $file)) {
            Write-Error "File $file tidak ditemukan!"
            exit 1
          }

          # String Lama (JSON Value Panjang)
          # Menggunakan single quote (') agar aman dari karakter spesial JSON
          $find = '"AMDGPU_TARGETS": "gfx940;gfx941;gfx942;gfx1010;gfx1012;gfx1030;gfx1100;gfx1101;gfx1102;gfx1151;gfx1200;gfx1201;gfx908:xnack-;gfx90a:xnack+;gfx90a:xnack-"'
          
          # String Baru
          $replace = '"AMDGPU_TARGETS": "gfx1103"'

          # Proses Replace Literal (Exact Match)
          Write-Host "Sedang memproses $file..."
          $content = Get-Content $file -Raw
          
          # Menggunakan method .NET .Replace() bukan operator -replace
          $newContent = $content.Replace($find, $replace)
          
          Set-Content -Path $file -Value $newContent
          Write-Host "Sukses: CMakePresets.json telah diupdate."

      # --- LANGKAH 4: VERIFIKASI (OPSIONAL) ---
      # Menampilkan isi file untuk memastikan perubahan berhasil (Hanya 5 baris pertama/terkait)
      - name: Verify Changes
        run: |
          Write-Host "--- Cek CMakePresets.json ---"
          Select-String -Path "CMakePresets.json" -Pattern "gfx1103"
          
          Write-Host "--- Cek CMakeLists.txt ---"
          Select-String -Path "CMakeLists.txt" -Pattern "gfx1150"

      # --- LANGKAH 5: CLEANUP WORKSPACE ---
      # Dijalankan selalu (if: always) agar disk server tidak penuh
      - name: Cleanup Workspace
        if: always()
        run: |
          Write-Host "Membersihkan folder kerja..."
          Remove-Item -Path $env:GITHUB_WORKSPACE\* -Recurse -Force -ErrorAction SilentlyContinue
          Write-Host "Pembersihan selesai."
